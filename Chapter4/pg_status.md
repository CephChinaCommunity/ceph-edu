# PG状态机

## 一、PG状态及转化过程

PG随着存储池的创建而产生，也随着存储池的删除而消亡，在其可长可短的一生当中，会经历数量增长（扩容时），也会经历数量减少（N版后支持），同时也会由于经受各种考验而呈现出不同的状态；对于运维人员而言，最喜欢也最放心的状态是active+clean，也是Ceph运维的目标。
PG的状态管理由RecoveryMachine成员管理，其状态转换如下图所示：

![PG状态变化示意图](images/PG状态转换图.png)

引起PG状态变化的主要场景有：
* 新建存储池，PG处于创建过程中；
* 新增或者删除OSD，进行数据迁移；
* OSD出现故障，进行数据恢复；
* 修改CRUSH map，进行数据迁移；
* PG各副本之间出现数据不一致；
* PG副本在进行数据校验；
* 存储系统无足够空间进行数据迁移或者恢复；
* OSD重启等。

## 二、各状态含义及触发条件

| PG状态       | 代表的含义/产生的条件                                                                                                       |
|--------------|-----------------------------------------------------------------------------------------------------------------------------|
| creating     | 表示PG正在被创建，通常以下两种情况下出现：<br>1.当存储池正在被创建；<br>2.增加一个存储池的PG数量时。                        |
| down         | 表示PG处于失效状态，一般出现在PG所在的OSD异常时。                                                                           |
| repair       | 表示PG正在被检查，被发现的任何不一致都将尽可能被修复。                                                                      |
| peering      | 由主OSD发起的，使存放PG副本的所有OSD就PG的所有对象和元素数据的状态达成一致的过程，该过程完成后主OSD就可以接受客户端写请求。 |
| active       | PG完成peering后，会变成active状态，意味着：<br>1.PG中的数据变得可用；<br>2.PG可响应读写请求。                               |
| clean        | 当PG显示CLEAN状态，主OSD与副本OSD成功同步并且没有异步复制，CEPH在PG中所有对象具有正确的副本数量。                           |
| replay       | 某OSD崩溃后，PG正在等待客户端重新发起操作。                                                                                 |
| inconsistent | PG副本出现不一致，对象大小不正确或者恢复结束后某个副本出现对象丢失现象。                                                    |
